- name: Create DB service
  hosts: "db"
  become: true

  #https://alexhernandez.info/articles/infrastructure/how-to-install-docker-using-ansible/

  tasks:
  # Setup virtaul machine
  - name: install dependencies
    apt:
        name: "{{item}}"
        state: present
        update_cache: yes
    loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg-agent
        - software-properties-common
  - name: add GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present
  - name: add docker repository to apt
    apt_repository:
      repo: deb https://download.docker.com/linux/ubuntu bionic stable
      state: present
  - name: install docker
    apt:
      name: "{{item}}"
      state: latest
      update_cache: yes
    loop:
      - docker-ce
      - docker-ce-cli
      - containerd.io
  - name: check docker is active
    service:
      name: docker
      state: started
      enabled: yes
  - name: Ensure group "docker" exists
    ansible.builtin.group:
      name: docker
      state: present
  - name: adding ubuntu to docker group
    user:
      name: ubuntu
      groups: docker
      append: yes
  - name: Install docker-compose
    get_url:
      url: https://github.com/docker/compose/releases/download/1.29.2/docker-compose-Linux-x86_64
      dest: /usr/local/bin/docker-compose
      mode: 'u+x,g+x'
  - name: Change file ownership, group and permissions
    ansible.builtin.file:
      path: /usr/local/bin/docker-compose
      owner: ubuntu
      group: ubuntu
      
  #Compy own files and start db services
  - name: mkdir repository
    ansible.builtin.file:
        path: /home/adminasier/db/Repositorios
        state: directory
  - name: mkdir storage
    ansible.builtin.file:
        path: /home/adminasier/db/Repositorios/storage
        state: directory
  - name: copy docker compose
    ansible.builtin.copy:
        src: /home/asier/cloud/MaquinasVirtuales/DB/Repositorios/docker-compose.yaml
        dest: /home/adminasier/db/Repositorios/
        remote_src: no
  - name: docker compose up
    command: docker-compose -f /home/adminasier/db/Repositorios/docker-compose.yaml up -d
    args:
      chdir: /home/adminasier/db/Repositorios